---
layout: post
title: C/C++ 调用约定
date: 2017-05-07 18:42:50
tags: 
    - C 
    - C++
categories: C++
    
---

`__cdecl` 是 C declaration 的缩写，表示 C 语言默认的函数调用方法：
- 所有参数从右到左依次入栈，
- 参数由调用者清除，称为手动清栈
- 被调用函数不会要求调用者传递多少参数，调用者传递过多或者过少的参数，甚至完全不同的参数都不会产生编译阶段的错误。

`__stdcall` 是 Standard Call 的缩写，是 C++ 的标准调用方式：
- 所有参数从右到左依次入栈，如果是调用类成员的话，最后一个入栈的是 this 指针。
- 这些堆栈中的参数由被调用的函数在返回后清除，使用的指令是 retn X，X 表示参数占用的字节数，CPU 在 ret 之后自动弹出 X 个字节的堆栈空间，称为自动清栈。
- 函数在编译的时候就必须确定参数个数，并且调用者必须严格的控制参数的生成，不能多，不能少，否则返回后会出错。

`__pascal` 是 Pascal 语言（Delphi）的函数调用方式，也可以在 C/C++ 中使用，参数压栈顺序与前两者相反。返回时的清栈方式与 `__stdcall` 相同。

`__fastcall` 是编译器指定的快速调用方式。由于大多数的函数参数个数很少，使用堆栈传递比较费时。因此 `__fastcall` 通常规定将前两个（或若干个）参数由寄存器传递，其余参数还是通过堆栈传递。不同编译器编译的程序规定的寄存器不同，返回方式和 `__stdcall` 相当。

`__thiscall` 是为了解决类成员调用中 this 指针传递而规定的。`__thiscall` 要求把 this 指针放在特定寄存器中，该寄存器由编译器决定。VC 使用 ecx，Borland 的 C++ 编译器使用 eax。返回方式和 `__stdcall` 相当。

`__fastcall` 和 `__thiscall` 涉及的寄存器由编译器决定，因此不能用作跨编译器的接口。所以 Windows 上的 COM 对象接口都定义为 `__stdcall` 调用方式。